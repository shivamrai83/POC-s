name: Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main, develop ]

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./CI-CD/backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: CI-CD/backend/package-lock.json
      
      - name: Install dependencies
        run: |
          npm ci || {
            echo "âš ï¸ npm ci failed, falling back to npm install"
            npm install
          }
      
      - name: Run tests
        run: npm run test:ci
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./CI-CD/backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: CI-CD/backend/coverage/
          retention-days: 7

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./CI-CD/frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: CI-CD/frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          npm ci || {
            echo "âš ï¸ npm ci failed, falling back to npm install"
            npm install
          }
      
      - name: Run tests
        run: npm run test:ci
        env:
          CI: true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./CI-CD/frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
      
      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: CI-CD/frontend/coverage/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: always()
    
    steps:
      - name: Generate test summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-backend.result }}" == "success" ]; then
            echo "âœ… All backend tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backend tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-frontend.result }}" == "success" ]; then
            echo "âœ… All frontend tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Frontend tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Coverage reports are available in the artifacts section." >> $GITHUB_STEP_SUMMARY

